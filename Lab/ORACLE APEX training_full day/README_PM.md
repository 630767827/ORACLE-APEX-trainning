## APEX动手实验-下午 2:00 - 5:30

## Workshop 概述

本次Workshop主要以动手为主，将带您从0开始快速体验如何在Apex应用中实现数据导入，如何自定义条件检索，如何快速生成图表，如何在Apex中实现邮件发送，以及工作流介绍。

预计时间：3小时以内



## 目录



- Lab 1 - 应用实现文件上传及数据导入

- Lab 2 - 自定义条件数据过滤

- Lab 3 -图表生成(Chart)

- Lab 4 - 邮件发送

- Lab 5 - 工作流

  

下记为数据文件的本次动手实验的示例数据[Data analysis.xlsx]。

![image-20230216190654620](images/image-20230216190654620.png)



****

****

### Lab 1 - 应用实现文件上传及数据导入

简介

Apex数据上传....通过复制和粘贴 CSV 数据、选择示例数据集或上传文件，将数据加载到Oracle APEX 。本次hands-on使用Excel上传数据文件。

将数据加载到APEX时的主要功能包括：

- 复制并粘贴 CSV 数据，或选择样本数据集。
- 上传文件（支持 CSV、XLSX、TXT、XML 或 JSON 文件）。

示例：

![image-20230524175147413](images/image-20230524175147413.png)



****

#### 任务1：开发者数据上传

点击‘SQL工作室 ->实用程序-> 数据工作室’ - (New Table 或 Existing Table)。

![image-20221227150631433](images/image-20221227150631433.png)

在数据工作室中，点击’数据加载‘。

![image-20221227150732705](images/image-20221227150732705.png)

点击’选择文件‘，选择'Data analysis.xlxs'文件。

![image-20221227150811726](images/image-20221227150811726.png)

在表名处设置目标表，填写新表名或选择现有表，配置完成后点击'数据加载'按钮。

※在此处...请大家在‘表名’处添加自己的前缀进行标识，如：XX_SALES_DATA_UPLOAD。

![image-20230213163025937](images/image-20230213163025937.png)

数据加载完成如下所示。

![image-20230213163952515](images/image-20230213163952515.png)



****

#### 任务2：最终用户数据上传

提供数据加载向导，最终用户可在界面上自行导入。

最终用户数据加载方法的有三种(附加、合并、替换)，设置该方法需数据模板创建完成后，在当前模板中设置。

附加(默认)   →      将行附加到表中。（insert）

合并：         →     将行合并到表中，必须为数据模板必须定义主键才能使用此选项。(insert/update)

替换：         →     加载新数据之前，将删除目标表或集合中的现有数据，然后再插入数据。(delete/insert)

##### ①创建应用程序

点击‘创建按钮’，创建Apex应用程序。

![image-20221227160558772](images/image-20221227160558772.png)

选择‘新建应用程序’。

![image-20221227160614052](images/image-20221227160614052.png)

点击'创建应用程序'。

![image-20230217142525028](images/image-20230217142525028.png)



##### ②定义数据加载模板

应用程序创建完成后，点击‘共享组件’。

![image-20230217142632222](images/image-20230217142632222.png)

在数据源中点击‘数据加载定义’。

![image-20221227161443644](images/image-20221227161443644.png)

点击‘创建’按钮，创建数据加载模板。

![image-20221227161544807](images/image-20221227161544807.png)

在创建数据加载画面，选择‘从头开始’，然后点击’下一步‘。

![image-20221227161647591](images/image-20221227161647591.png)

选择数据上传目标表，然后点击’下一步‘。选择Lab1-任务1中的表名。

![image-20230213164759773](images/image-20230213164759773.png)

选择数据加载模板Excel文件后，然后点击’下一步‘。

![image-20230213164909463](images/image-20230213164909463.png)

配置映射列(此处...可修改列的映射关系)，然后点击’创建并添加页‘。

![image-20230213165302470](images/image-20230213165302470.png)



##### ③创建数据上传页

在②中点击’创建并添加页‘按钮后，会跳转到’文件上传‘向导页，然后点击‘创建页’。

![image-20230213165546384](images/image-20230213165546384.png)

页面创建成功后，如下所示，点击运行画面。

![image-20230213165650852](images/image-20230213165650852.png)

输入个人的Apex用户/密码，点击登录即可。

![image-20230213165707054](images/image-20230213165707054.png)

画面运行结果如下所示。

![image-20230213165735189](images/image-20230213165735189.png)



##### ④数据上传测试

事前查询XX_SALES_DATA_UPLOAD表中数据条数，或删除表中的数据。

※路径：'SQL工作室'->'SQL命令'。

```sql
SELECT COUNT(1) FROM wb_sales_data_upload;
```

![image-20230213170125430](images/image-20230213170125430.png)



数据件数确认后，返回销售数据上传画面，点击’选择文件‘按钮，上传数据文件。

![image-20230213170724105](images/image-20230213170724105.png)



数据文件选择后，点击’数据加载‘按钮把数据上传到Apex中。

![image-20230213171001554](images/image-20230213171001554.png)

如下所示，数据上传成功。

![image-20230213171510266](images/image-20230213171510266.png)

接下来...返回‘SQL工作室'->'SQL命令'中，使用SQL....查询XX_SALES_DATA_UPLOAD表中的数据件数。

![image-20230213171425111](images/image-20230213171425111.png)



如之前所说，Apex中最终用户数据上传方法的有三种(附加、合并、替换)，上记演示的为附加，数据文件Excel中存在20条数据，上传成功后...在DB中可发现这20条数据，如再次点击上传Excel数据文件，那么报表则会增加到40条数据。剩余的合并、替换大家可以尝试一下。



***

#### 概况

这样就完成了Lab1，您现在知道如何在Apex中上传数据。



****

****







****

### Lab 2 - 自定义条件数据过滤

<b><span style='color:red;'>提示：Lab2中原本使用的是员工表的数据，但在本次动手实验中，请使用Lab1中创建的表[XX_SALES_DATA_UPLOAD]代替。</span></b>

简介

在Apex中过滤功能有很多，如行内搜索、分面搜索、应用搜索这些搜索都是Apex组件化的(封装好的)可以直接使用。另外，在某些业务场景中，需要自定义条件过滤时，也可以结合输入框及Report完成。

接下来我们一起动手看一下，在Apex如何自定义过滤搜索。

示例：

![image-20230403145905106](images/image-20230403145905106.png)

※如上图所示，在画面中输入检索条件后，点击检索按钮，即可搜索出满足条件的数据。



****

#### 任务1：创建画面区域

找到Lab 1 创建的Apex应用，进入该应用后，点击‘主页’。

![image-20230331155602153](images/image-20230331155602153.png)

鼠标选择Body处点击鼠标右键，点击‘创建区域’。

![image-20230331155714617](images/image-20230331155714617.png)

区域创建完成后，修改其标题为‘检索条件’。

![image-20230331155850518](images/image-20230331155850518.png)

鼠标选择检索区域，然后点击鼠标右键，接着点击‘重复’，点击重复后则会帮我们复制选中的区域。

![image-20230331155956980](images/image-20230331155956980.png)

区域复制完成后，修改其标题为‘EMP报表’。

![image-20230331160225947](images/image-20230331160225947.png)

如上所示，设置完成后，点击保存按钮...保存Apex画面。

![image-20230331160412077](images/image-20230331160412077.png)



****

#### 任务2：添加搜索条件

备注：Apex 页项名称(PX_NEW)解读，’P‘表示页(page)，’X‘表示当前页的页码，’_NEW‘为页项名称。

选择‘检索条件’区域，点击鼠标右键，然后选择‘创建项’。

![image-20230331160609797](images/image-20230331160609797.png)

页项创建完成后，修改其’名称‘=>P1_NAME,’标签‘=>姓名。

![image-20230331160848671](images/image-20230331160848671.png)

再次选择检索条件区域，点击鼠标右键，然后选择‘创建项’。

页项创建完成后，修改其’名称‘=>P1_JOB；'类型'=>选择列表；’标签‘=>职位；'开始新行'=>OFF;‘值列表类型’=>SQL查询。

※ 在SQL查询中输入输入下记SQL。

```SQL
SELECT job d,
       job r
FROM   XX_EMP
```

![image-20230331163058634](images/image-20230331163058634.png)![image-20230331163139047](images/image-20230331163139047.png)

运行‘Apex画面’。

![image-20230331163300557](images/image-20230331163300557.png)

画面运行结果，如下所示。

![image-20230331163320898](images/image-20230331163320898.png)

****

#### 任务3：创建经典报表

选择‘Emp报表区域’，区域类型选择‘经典报表’。

![image-20230331163505140](images/image-20230331163505140.png)

’源‘处的表名选择 ‘Lab 2 -> 任务1’ 中对应的表名<XX_EMP>,要提交的页项选择‘P1_NAME,P1_JOB’。

![image-20230331163633333](images/image-20230331163633333.png)

展开Emp区域报表的列。报表列的属性如下按下记表格内容进行设定，列标题设置成中文标题后，画面展示时报表列标题才会以中文进行展示。

| 列名       | 类型 | 标题     |
| ---------- | ---- | -------- |
| ID         | 隐藏 |          |
| LOCATION   | 默认 | 地点     |
| DEPARTMENT | 默认 | 部门     |
| EMPNO      | 默认 | 员工编号 |
| NAME       | 默认 | 员工姓名 |
| JOB        | 默认 | 职位     |
| HIREDATE   | 默认 | 入职日期 |
| SALARY     | 默认 | 工资     |
| COMMMISION | 默认 | 奖金     |
| MANAGER    | 默认 | 上级领导 |
| DEPTNO     | 默认 | 部门编号 |

修改完成后，点击运行。

![image-20230403143653597](images/image-20230403143653597.png)

运行结果如下所示。

![image-20230403143834137](images/image-20230403143834137.png)



****

#### 任务4：建立操作

给报表SQL文添加下记查询条件。

```sql
(:P1_NAME IS NULL OR name LIKE '%'||:P1_NAME||'%')
AND
(:P1_JOB IS NULL OR :P1_JOB = job)
```

![image-20230403144754163](images/image-20230403144754163.png)

点击检索条件区域，鼠标右键点击后...选择'创建按钮'。

![image-20230403144946840](images/image-20230403144946840.png)

按钮名设置为‘Search’，标签(显示值)设置为‘检索’，位置设置为‘区域以下(旧)’。

![image-20230403145142746](images/image-20230403145142746.png)

点击Emp报表区域，在外观处修改其模板的属性为‘Interactive Report’，修改完成后，点击运行。

![image-20230403144131437](images/image-20230403144131437.png)

运行结果如下所示。

※直到此处，Apex自定义搜索已经创建完成，如下...我们可以根据姓名和职位对员工表的数据进行搜索。

![image-20230403145521404](images/image-20230403145521404.png)



***

#### 概况

这样就完成了Lab2，您现在知道如何在Apex中自定义搜索。



***

***

### Lab 3 -图表生成(Chart)

(Lab 3 - 任务1~2)效果图如下所示：

![image-20230214182152854](images/image-20230214182152854.png)

#### 任务1：chart图表(※向导创建)

##### ①每月銷售統計(达标率)

在应用程序页中点击‘创建页’。

![image-20230214163354907](images/image-20230214163354907.png)

在创建页的向导中选择图表，然后点击’下一步‘。

![image-20221228123931194](images/image-20221228123931194.png)

选择‘状态测量仪数据计量表’，点击‘下一步’。

![image-20230214163502841](images/image-20230214163502841.png)

输入任意画面名称后，数据源选择‘SQL查询’。

```plsql
SELECT
  sum(WB_UNIT_PRICE*WB_QUANTITY) sales_total,
  4000000  as  target_total
FROM WB_SALES_DATA_UPLOAD;
```

![image-20230214164221976](images/image-20230214164221976.png)

![image-20230214164439121](images/image-20230214164439121.png)

画面创建完成后，如下所示。点击‘运行’。

![image-20230214164732568](images/image-20230214164732568.png)

画面显示效果如下。

![image-20230214165358183](images/image-20230214165358183.png)

#### 任务2：chart图表(※非向导创建)

##### ①前十大销售

右键点击Body区域，选择’创建区域‘。

![image-20230214174150524](images/image-20230214174150524.png)

把区域名称修改为’前十大销售‘，类型选择’图表‘。

![image-20230214174242464](images/image-20230214174242464.png)

点击区域属性，修改图表类型为’折线图‘。

![image-20230214174802562](images/image-20230214174802562.png)

点击系列，在系列属性中找到源，把’表/试图‘修改为’SQL查询‘。

![image-20230214175004901](images/image-20230214175004901.png)

把下记SQL文放入图表的‘代码编辑器-SQL查询’画面中。放入完成后，点击’确认‘。

```sql
-- 获取前10总销售额。
SELECT * 
FROM( 
    SELECT WB_BUSINESS_ID, 
           sum(WB_UNIT_PRICE*WB_QUANTITY)
    FROM WB_SALES_DATA_UPLOAD
    group by WB_BUSINESS_ID
    order by sum(WB_UNIT_PRICE*WB_QUANTITY) DESC
    )
WHERE ROWNUM <= 10
```

![image-20230214175134771](images/image-20230214175134771.png)

标签设置为业务员ID，值设置为总销售额，设置完成后，点击’运行‘。

![image-20230214175226951](images/image-20230214175226951.png)

画面显示效果如下。

![image-20230214175252738](images/image-20230214175252738.png)



##### ②地区销售

右键点击Body区域，选择’创建区域‘。

![image-20230214175333012](images/image-20230214175333012.png)

把区域名称修改为’地区销售‘，类型选择’图表‘。

![image-20230214175423923](images/image-20230214175423923.png)

点击区域属性，修改图表类型为’饼图‘。

![image-20230214175515510](images/image-20230214175515510.png)

点击系列，在系列属性中找到源，把’表/试图‘修改为’SQL查询‘。

![image-20230214175613543](images/image-20230214175613543.png)

把下记‘SQL文’放入图表的‘代码编辑器-SQL查询’画面中。放入完成后，点击’确认‘。

```sql
-- 获取地区的销售额
SELECT WB_AREA, 
       SUM(WB_UNIT_PRICE * WB_QUANTITY) 
FROM   WB_SALES_DATA_UPLOAD
GROUP BY WB_AREA
ORDER BY WB_AREA;
```

![image-20230214175752753](images/image-20230214175752753.png)

标签设置为厂区，值设置为总销售额，标签显示效果设置为‘标签-百分比’，设置完成后，点击’运行‘。

![image-20230214175905316](images/image-20230214175905316.png)

画面显示效果如下。

![image-20230214180006147](images/image-20230214180006147.png)

##### ③(同产品·不同厂区)销售比较(前10)

右键点击Body区域，选择’创建区域‘。

![image-20230214180341972](images/image-20230214180341972.png)

把区域名称修改为’(同产品·不同厂区)销售比较(前10)‘，类型选择’图表‘。

![image-20230214180436395](images/image-20230214180436395.png)

点击系列，在系列属性中找到源，把’表/试图‘修改为’SQL查询‘。

![image-20230214180538486](images/image-20230214180538486.png)

把下记SQL文放入图表的‘代码编辑器-SQL查询’画面中。放入完成后，点击’确认‘。

```sql
-- 获取同产品不同厂区的总销售额
SELECT * 
FROM (
    SELECT WB_SITE, 
       WB_PRODUCT_CLASS,
       SUM(WB_UNIT_PRICE * WB_QUANTITY) 
    FROM   WB_SALES_DATA_UPLOAD
    GROUP BY WB_SITE,WB_PRODUCT_CLASS
    ORDER BY SUM(WB_UNIT_PRICE * WB_QUANTITY) DESC
)
WHERE ROWNUM <= 10;
```

![image-20230214180919129](images/image-20230214180919129.png)

系列名设置为产品分类，标签设置为厂区，值设置为总销售额。

![image-20230214181102542](images/image-20230214181102542.png)

选择区域，点击属性，在属性中打开图列显示。设置完成后，点击’运行‘。

![image-20230214181204296](images/image-20230214181204296.png)

画面显示效果如下。

![image-20230214181558434](images/image-20230214181558434.png)



温馨提示：上记的Chart图表都是按照顺序从上到下依次排列。如果想要修改Chart图表的排列顺序，只需选中图表区域，在区域中找到是否’开启新行‘，通过该属性...就可以做到让多个图表在一行排列。



****

#### 概况

这样就完成了Lab3，您现在知道如何在Apex中构建图表。



****

****

### Lab 4 - 邮件发送

简介

电子邮件是一种用电子手段提供信息交换的通信方式，是互联网应用最广的服务。在Apex中也提供了邮件发送功能(封装好的邮件发送组件)，并配有对应的PLSQL API。

https://docs.oracle.com/en/database/oracle/application-express/21.2/aeapi/APEX_MAIL.html#GUID-14F51C6D-CB82-4B38-AB6E-61C46E75596F

经典的应用场景：业务信息变更时进行邮件通知、订阅功能。

接下来我们一起动手，看一下Apex的邮件发送功能。

![image-20230403160254558](images/image-20230403160254558.png)

****



#### 任务1：创建空白页面

 返回Lab1中创建的应用程序中，点击‘创建页’。

![image-20230403151230227](images/image-20230403151230227.png)

在创建页画面向导中点击‘空白页’。

![image-20230403151325285](images/image-20230403151325285.png)

画面名称设置为‘邮件发送’，设置完成后，点击创建页。

![image-20230403151446371](images/image-20230403151446371.png)

画面创建完成后，如下所示。

![image-20230403151746843](images/image-20230403151746843.png)



****

#### 任务2：添加收件人、主题、正文Info

首先选择Body后，再点击鼠标右键，选择创建区域。

![image-20230403151813082](images/image-20230403151813082.png)

修改区域标题为‘发送邮件Info’。

![image-20230403152124159](images/image-20230403152124159.png)

接下来在发送邮件Info区域中创建三个页项。按下记表格内容对页项进行设定。

| 名称         | 类型     | 标签   | 开始新行 |
| ------------ | -------- | ------ | -------- |
| P2_TO        | 文本字段 | 收件人 | ON       |
| P2_SUBJECT   | 文本字段 | 主题   | OFF      |
| P2_BODY_TEXT | 文本区域 | 正文   | ON       |

![image-20230403153151226](images/image-20230403153151226.png)

接下来添加邮件发送按钮，鼠标点击右键，选择创建按钮。

![image-20230403153553391](images/image-20230403153553391.png)

按钮属性如下进行设定，设置完成后点击运行。

按钮名=>SEND，标签=>发送邮件，位置=>区域以下(旧)，热门=>ON。

![image-20230403153711753](images/image-20230403153711753.png)

运行结果如下所示。

![image-20230403154014835](images/image-20230403154014835.png)

****

#### 任务3：在处理中添加邮件发送组件功能

点击Tab‘处理’，找到页面处理部分，点击鼠标右键创建新的‘处理’。

![image-20230403154317153](images/image-20230403154317153.png)

处理按照下记表格内容进行设定,设置完成后，点击‘保存’。

| 名称     | 类型         | 收件人  | 主题         | 正文纯文本     | 在按下按钮时-条件 | 成功消息     |
| -------- | ------------ | ------- | ------------ | -------------- | ----------------- | ------------ |
| 邮件发送 | 发送电子邮件 | &P2_TO. | &P2_SUBJECT. | &P2_BODY_TEXT. | SEND              | 邮件发送成功 |

![image-20230403154750353](images/image-20230403154750353.png)

![image-20230403155321986](images/image-20230403155321986.png)



#### 任务4：邮件发送测试

运行画面后，在画面中输入收件人、主题、正文后，点击按钮‘发送右键’。

![image-20230403155817494](images/image-20230403155817494.png)

如下所示，outlook中收到了Apex中发来的邮件。

![image-20230403155932502](images/image-20230403155932502.png)



****

#### 概况

这样就完成了Lab3，您现在知道如何在Apex中使用邮件发送功能。



****

****

### Lab 5 - 工作流

简介

工作流在企业中应用非常广泛。如：请假、出差、采购及日常报销等都需要此功能，Apex在22.1加入了审批流功能，使用Apex的的审批流功能，能极大的简化人工审批的定义，且包含多种数据模型，在有工作流相关的业务场景下，只需简单配置就可直接使用。不需要做大量的开发和调试，其它的都是通过Apex审批流组件自动完成创建完成。

特点① => 自动建立任务列表、搜索，待审批列表。

特点② => 自动建立详情页（任务过期时间，备注，历史，优先级，审批人分配，撤回，取消，同意，拒绝等）。

特点③ => 有完整的审批流生命周期。

特点④ => 支持邮寄推送、执行脚本、支持多级审批。



接下来我们一起做一个非常简单的工作流Demo(员工工资变更审批)。

![image-20230404132935796](images/image-20230404132935796.png)

****

#### 任务1：添加Apex用户

※该用户用于Apex审批流中的审批者。

![image-20230403174034780](images/image-20230403174034780.png)

进入管理用户和组画面后，点击’创建用户名‘按钮，添加新的用户’Bo‘，创建成功后，如下所示。

![image-20230403174107076](images/image-20230403174107076.png)



****

#### 任务2：工作流定义

##### ①.创建工作流定义

进入Lab1创建的应用程序，点击共享组件。

![image-20230403172205505](images/image-20230403172205505.png)

在共享组件画面，点击’任务定义‘。

![image-20230403172251620](images/image-20230403172251620.png)

在’任务定义‘中，点击’创建'按钮创建工作流定义。

![image-20230403172338185](images/image-20230403172338185.png)

在创建任务定义画面中，按照下记表格内容进行设定，设定完成后点击’创建‘。

| 名称         | 主题         | 静态ID        | 优先级 | 潜在所有者(审批者)     | 业务管理员       |
| ------------ | ------------ | ------------- | ------ | ---------------------- | ---------------- |
| 工资变更审批 | 工资变更审批 | sales_changes | 中     | Lab5-任务1中添加的用户 | 自己当前Apex用户 |

![image-20230403173818541](images/image-20230403173818541.png)

创建完成后，如下所示。

![image-20230403173918894](images/image-20230403173918894.png)

##### ②.添加任务详细页

点击设置中的’创建详细信息页‘的按钮。

![image-20230403174823794](images/image-20230403174823794.png)

在弹出确认信息后，点击’确认‘按钮。

![image-20230403175021504](images/image-20230403175021504.png)

如下所示，Apex已经自动帮我们创建好了工作流的任务详细页。

![image-20230403175051459](images/image-20230403175051459.png)

##### ③.修改工作流任务主题

点击进入工作流定义’工资变更审批‘，进入任务定义详细画面。

![image-20230403175241927](images/image-20230403175241927.png)

添加一个参数P_SALARY,该参数用于接收修改后的最新工资。

![image-20230403180039271](images/image-20230403180039271.png)

修改工作流定义的主题和操作源，按下表格式进行修改，修改完成后点击’应用更改‘。

| 名称           | 值                                                           |
| -------------- | ------------------------------------------------------------ |
| 主题           | &NAME.工资变更审批(变更前工资：&SALARY. => 变更后工资： &P_SALARY.) |
| 操作源-SQL查询 | SELECT NAME,SALARY FROM xx_emp WHERE id = :APEX$TASK_PK      |

![image-20230403180412070](images/image-20230403180412070.png)



##### ④.添加操作

※审批同意后，把最新工资更新到XX_EMP表的SALARY列，只需添加一个操作，在操作中可通过工作流的生命周期实现，工资列的更新。

点击进入工作流定义’工资变更审批‘，进入任务定义详细画面。

![image-20230403175241927](images/image-20230403175241927.png)

点击’添加操作‘按钮。

![image-20230403180758950](images/image-20230403180758950.png)

在编辑表格画面按照下记表格内容进行设定。设定完成后点击保存。

| 名称       | 值                                                           |
| ---------- | ------------------------------------------------------------ |
| 操作-名称  | 更新xx_emp表的工资列                                         |
| 类型       | 执行代码                                                     |
| 发生事件时 | 完成-已批准                                                  |
| 代码       | UPDATE XX_EMP SET SALARY = :P_SALARY WHERE ID = :APEX$TASK_PK； |

![image-20230403181328689](images/image-20230403181328689.png)

![image-20230403181113103](images/image-20230403181113103.png)



操作创建成功后，如下所示。

![image-20230403181521292](images/image-20230403181521292.png)



****

#### 任务3：建立任务列表

##### ①我的提交画面

返回Lab1创建的应用程序中，点击‘创建页’。

![image-20230404092926757](images/image-20230404092926757.png)

点击向导‘统一任务列表’。

![image-20230404093009667](images/image-20230404093009667.png)

画面名称设定为‘我的提交’，报表上下文选择‘由我启动’，设定完成后，点击‘创建页’。

![image-20230404093320825](images/image-20230404093320825.png)

我的提交画面创建完成后，点击右上角的运行按钮，运行此画面。

![image-20230404093456656](images/image-20230404093456656.png)

运行结果如下所示。

![image-20230404093814830](images/image-20230404093814830.png)



##### ②我的审批画面 

返回Lab1创建的应用程序中，点击‘创建页’。

![image-20230404093959954](images/image-20230404093959954.png)

点击向导‘统一任务列表’。

![image-20230404094028969](images/image-20230404094028969.png)

画面名称设定为‘我的审批’，报表上下文选择‘我的任务’，设定完成后，点击‘创建页’。

![image-20230404094128473](images/image-20230404094128473.png)

我的审批画面创建完成后，点击右上角的运行按钮，运行此画面。

![image-20230404094213240](images/image-20230404094213240.png)

运行结果如下所示。

![image-20230404094309539](images/image-20230404094309539.png)

##### ③审批任务管理画面

返回Lab1创建的应用程序中，点击‘创建页’。

![image-20230404093959954](images/image-20230404093959954.png)

点击向导‘统一任务列表’。

![image-20230404094446352](images/image-20230404094446352.png)

画面名称设定为‘审批任务管理’，报表上下文选择‘管理任务’，设定完成后，点击‘创建页’。

![image-20230404095127965](images/image-20230404095127965.png)

审批任务管理画面’创建完成后，点击右上角的运行按钮，运行此画面。

![image-20230404095150547](images/image-20230404095150547.png)

运行结果如下所示。

![image-20230404095210647](images/image-20230404095210647.png)

##### ④待审批画面

返回Lab1创建的应用程序中，点击‘创建页’。

![image-20230404093959954](images/image-20230404093959954.png)

点击向导‘交互式报表’。

![image-20230404095801954](images/image-20230404095801954.png)

画面名称设定为‘待审批画面’，源类型选择‘SQL查询’，输入下记SQL文，设定完成后，点击‘创建页’。

```SQL
select t.task_id, 
       t.subject,
       t.priority,
       t.initiator,
       case 
            when t.state_code = 'ASSIGNED' then 
                t.state||' to '||t.actual_owner
            when t.state_code = 'UNASSIGNED' then 
                t.state||' ('||eba_demo_appr.approvers_for_task(t.task_id)||')'
            when t.state_code = 'EXPIRED' then
                'Expired after '||
                (select listagg(t3.actual_owner,'←')
                   from apex_tasks t3
                   connect by prior t3.previous_task_id = t3.task_id
                   start with t3.task_id = t.task_id)
        end status,
        eba_demo_appr.admins_for_task(t.task_id) as admins,
        t.due_on due_by,
        eba_demo_appr.details_task_url(
          p_url     => d.details_link_target,
          p_app_id  => d.application_id,
          p_task_id => t.task_id) details_link_target,
       due_in, 
       case 
          when due_in_hours <   0 then 'OVERDUE'
          when due_in_hours <   1 then 'NEXT_HOUR'
          when due_in_hours <  24 then 'NEXT_24_HOURS'
          when due_in_hours < 168 then 'NEXT_7_DAYS'
          when due_in_hours < 720 then 'NEXT_30_DAYS'
          else            'MORE_THAN_30_DAYS'
      end due_code,
      case when state_code in ('COMPLETED', 'CANCELED') 
                                               then 'Y'
                                               else 'N'
                                          end is_completed         
from (
select task_id,
       task_def_id,
       subject,
       priority,
       initiator,
       actual_owner,
       due_on,
       apex_util.get_since(due_on) due_in,
       round((cast(due_on as date) - sysdate) * 24, 1) due_in_hours,
       state_code,
       state
       from apex_Tasks
) t
left join apex_appl_taskdefs d on d.task_def_id = t.task_def_id 
where 
       STATIC_ID in ('sales_changes')
       and 
      (t.state_code in ('UNASSIGNED','ASSIGNED')
      or
      (
          t.state_code = 'EXPIRED' 
           and not exists (select 1 
                             from apex_tasks t2 
                            where previous_task_id = t.task_id)
      )
      )
order by due_by
```

![image-20230404095922045](images/image-20230404095922045.png)

待审批画面’创建完成后，点击右上角的运行按钮，运行此画面。

![image-20230404100115604](images/image-20230404100115604.png)

运行结果如下所示。

![image-20230404100206895](images/image-20230404100206895.png)



****

#### 任务4：员工工资变更申请

##### ①员工信息画面

返回Lab1创建的应用程序中，点击‘创建页’。

![image-20230404093959954](images/image-20230404093959954.png)

点击向导‘卡片‘。

![image-20230404102657050](images/image-20230404102657050.png)

画面名称设定为‘员工信息’，表/视图名设定为‘XX_EMP’，设定完成后，点击‘下一步’。

![image-20230404103250465](images/image-20230404103250465.png)

卡片按照下记表格内容进行设定,设定完成后，点击‘创建页’。

| 卡片布局 | 标题列 | 正文列 | 图标首字母缩写列 |
| -------- | ------ | ------ | ---------------- |
| 网格     | NAME   | SALARY | NAME             |

![image-20230404103439494](images/image-20230404103439494.png)

员工信息页创建成功后，如下所示，点击右上角的运行按钮，运行此画面。

![image-20230404103659585](images/image-20230404103659585.png)

运行结果如下所示。

![image-20230404103800075](images/image-20230404103800075.png)



##### ②工资变更申请画面

返回Lab1创建的应用程序中，点击‘创建页’。

![image-20230404093959954](images/image-20230404093959954.png)

点击向导‘空白页’。

![image-20230404102626266](images/image-20230404102626266.png)

画面名称设定为‘工资变更申请’，页模式设定为‘模式对话框’，设定完成后，点击‘创建页’。

![image-20230404104145862](images/image-20230404104145862.png)

页面创建成功后，如下所示。

![image-20230404104310823](images/image-20230404104310823.png)

点击Content Body，鼠标右键创建区域，区域标题设置为‘员工工资变更’。

![image-20230404104612097](images/image-20230404104612097.png)

选择员工工资变更区域，鼠标右键创建4个页项，4个页项的属性按下记表格内容进行设定。

| 名称       | 类型     | 设置-受保护 | 标签     |
| ---------- | -------- | ----------- | -------- |
| P9_ID      | 隐藏     | OFF         | -        |
| P9_ENAME   | 仅显示   | -           | 员工姓名 |
| P9_SAL     | 仅显示   | -           | 当前工资 |
| P9_NEW_SAL | 数字字段 | -           | 申请工资 |

![image-20230404105449432](images/image-20230404105449432.png)

选择员工工资变更区域，鼠标右键创建‘提交申请’按钮,该按钮按下记表格内容进行设定。

| 按钮名 | 标签     | 热门 | Width-模板选项 |
| ------ | -------- | ---- | -------------- |
| SUBMIT | 提交申请 | ON   | Stretch        |

![image-20230404105724709](images/image-20230404105724709.png)

![image-20230404105818464](images/image-20230404105818464.png)

点击‘员工工资变更区域’，设置区域模板为‘Blank with Attributes’，设置完成后点击‘保存’。

![image-20230404113328726](images/image-20230404113328726.png)

##### ③(逻辑)发起工作流任务

点击Tab‘处理’，找到页面处理部分，点击鼠标右键创建新的‘处理’。

![image-20230404110143398](images/image-20230404110143398.png)

新建的处理按下记表格内容进行设定。

| 名称       | 类型          | 定义                         | 详细信息主键项 |
| ---------- | ------------- | ---------------------------- | -------------- |
| 发起工作流 | 人工任务-创建 | <Lab4-任务2创建的工作流定义> | P9_ID          |

![image-20230404110428642](images/image-20230404110428642.png)

点击参数‘工作流参数’区域，类型设定为‘项’。项设置为‘P9_NEW_SAL’，设置完成后，点击保存。

![image-20230404110744637](images/image-20230404110744637.png)

点击‘处理之后’，然后鼠标点击右键创建分支。

![image-20230404135444297](images/image-20230404135444297.png)

’服务端条件处-在按下按钮时‘设定为'SUBMIT',设定完成后，点击目标‘未定义链接’。

![image-20230404135545124](images/image-20230404135545124.png)

在link的属性中设定目标页的页码为8(员工信息画面)，设定完成后点击‘确认’。

![image-20230404135743593](images/image-20230404135743593.png)

接着点击‘保存’。

![image-20230404135915129](images/image-20230404135915129.png)

##### ⑤添加页面跳转逻辑(①page->②page)

※添加页面跳转逻辑的原因

​      =>如对员工工资进行变更，需从员工信息画面跳转到工资变更申请画面，输入最新工资后..再发起申请。

如下图所示，根据下图所标记的序号顺序回到回到员工信息画面。

![image-20230404111918062](images/image-20230404111918062.png)

点击员工信息区域的操作，鼠标右键点击创建操作。

![image-20230404112040875](images/image-20230404112040875.png)

操作类型设置为‘按钮’，标签设置为‘工资变更申请’。

![image-20230404112158893](images/image-20230404112158893.png)

点击连接处的‘未定义连接’处，打开link设定。

![image-20230404112300482](images/image-20230404112300482.png)

链接属性按照下记表格内容进行设定,设置完成后，点击‘确认’。

| 目标-页             | 名称1-值1     | 名称2-值2          | 名称3-值3           | 清除高速缓存 | 操作     |
| ------------------- | ------------- | ------------------ | ------------------- | ------------ | -------- |
| 9（工资变更申请页） | P9_ID => &ID. | P9_ENAME => &NAME. | P9_SAL = > &SALARY. | 9            | 清除区域 |

![image-20230404112643013](images/image-20230404112643013.png)

link设置完成后，点击页面右上角的‘运行’按钮，运行画面。

![image-20230404113100453](images/image-20230404113100453.png)

画面运行结果如下所示。点击‘工资变更申请’按钮。

![image-20230404113539935](images/image-20230404113539935.png)

点击‘工资变更申请’按钮后，则会打开子画面‘工资变更申请’画面。

![image-20230404113626866](images/image-20230404113626866.png)



****

#### 任务5：审批流测试提示

提示1：审批流测试时，推荐大家新建一个test用户去发起工作流。

![image-20230404135111096](images/image-20230404135111096.png)

提示2：Apex工作流提供了完整的生命周期，我们可以在相应的生命周期中触发各项操作，如：审批拒绝or审批承认时...触发邮件提醒。

#### 概况

这样就完成了Lab5，您现在知道如何在Apex中添加审批流，以及使用审批流。
